<!doctype html>
<!--suppress ALL -->
<html lang="zh-CN" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1 , user-scalable=no">
    <title>微电影</title>
    <link rel="shortcut icon" th:href="@{/base/images/logo.png}">
    <link rel="stylesheet" th:href="@{/base/css/bootstrap.min.css}"rel="stylesheet" type="text/css">
    <link rel="stylesheet" th:href="@{/base/css/bootstrap-movie.css}"rel="stylesheet" type="text/css">
    <link rel="stylesheet" th:href="@{/base/css/animate.css}"rel="stylesheet" type="text/css">
    <link rel="stylesheet" th:href="@{/base/css/jquery.gritter.min.css}" type="text/css">
    <style>
        .navbar-brand>img {
            display: inline;
        }
        .media{
            padding:3px;
            border:1px solid #ccc
        }
        .col-lg-1, .col-lg-10, .col-lg-11, .col-lg-12, .col-lg-2, .col-lg-3, .col-lg-4, .col-lg-5, .col-lg-6, .col-lg-7, .col-lg-8, .col-lg-9, .col-md-1, .col-md-10, .col-md-11, .col-md-12, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6, .col-md-7, .col-md-8, .col-md-9, .col-sm-1, .col-sm-10, .col-sm-11, .col-sm-12, .col-sm-2, .col-sm-3, .col-sm-4, .col-sm-5, .col-sm-6, .col-sm-7, .col-sm-8, .col-sm-9, .col-xs-1, .col-xs-10, .col-xs-11, .col-xs-12, .col-xs-2, .col-xs-3, .col-xs-4, .col-xs-5, .col-xs-6, .col-xs-7, .col-xs-8, .col-xs-9{
            padding-right: 3px;
            padding-left: 3px;
        }


    </style>

</head>

<body>
<div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <div class="panel-heading">
                    <h3 class="panel-title"><span class="glyphicon glyphicon-log-in"></span>&nbsp;会员登录</h3>
                </div>
            </div>
            <div class="panel-body">
                <form id="login_form" role="form">
                    <fieldset>
                        <div class="form-group">
                            <label for="input_contact"><span class="glyphicon glyphicon-user"></span>&nbsp;账号</label>
                            <input id="input_contact" class="form-control input-lg" placeholder="邮箱" name="mail" type="text" autofocus>
                        </div>
                        <div class="col-md-12" id="error_contact"></div>
                        <div class="form-group">
                            <label for="input_password"><span class="glyphicon glyphicon-lock"></span>&nbsp;密码</label>
                            <input id="input_password" class="form-control input-lg" placeholder="密码" name="passworld" type="password" value="">
                        </div>
                        <div class="col-md-12" id="error_password"></div>
                        <a href="javasript:void(0)" onclick="login()" class="btn btn-lg btn-success btn-block">登录</a>
                    </fieldset>
                </form>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal -->
</div>

<!--
    作者：644773746@qq.com
    时间：2019-05-02
    描述：注册的弹出框
-->
<div class="modal fade" id="registerModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <div class="panel-heading">
                    <h3 class="panel-title"><span class="glyphicon glyphicon-plus"></span>&nbsp;会员注册</h3>
                </div>
            </div>
            <div class="panel-body">
                <div class="panel-body">
                    <form id="register_form" role="form">
                        <fieldset>
                            <div class="form-group">
                                <label for="name"><span class="glyphicon glyphicon-user"></span>&nbsp;昵称</label>
                                <input class="form-control input-lg" placeholder="昵称" name="name" type="text" autofocus>
                            </div>
                            <div class="col-md-12" id="error_name"></div>
                            <div class="form-group">
                                <label for="email"><span class="glyphicon glyphicon-envelope"></span>&nbsp;邮箱</label>
                                <input name="mail" class="form-control input-lg" placeholder="邮箱"  type="email" autofocus>
                            </div>
                            <div class="col-md-12" id="error_email"></div>
                            <div class="form-group">
                                <label for="phoneNum"><span class="glyphicon glyphicon-phone"></span>&nbsp;手机</label>
                                <input name="phonenumber" class="form-control input-lg" placeholder="手机" type="text" autofocus>
                            </div>
                            <div class="col-md-12" id="error_phone"></div>
                            <div class="form-group">
                                <label for="password"><span class="glyphicon glyphicon-lock"></span>&nbsp;密码</label>
                                <input id="passworld" class="form-control input-lg" placeholder="密码" name="passworld" type="password">
                            </div>
                            <div class="col-md-12" id="error_password"></div>
                            <div class="form-group">
                                <label for="repassword"><span class="glyphicon glyphicon-lock"></span>&nbsp;确认密码</label>
                                <input id="repassword" class="form-control input-lg" placeholder="确认密码" name="repassword" type="password">
                            </div>
                            <div class="col-md-12" id="error_repassword"></div>
                            <a href="javascript:void(0)" onclick="register()" class="btn btn-lg btn-success btn-block">注册</a>
                        </fieldset>
                    </form>
                </div>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal -->
</div>
</div>
<!--导航-->
<nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
        <!--小屏幕导航按钮和logo-->
        <div class="navbar-header">
            <button class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="/movie/list/2018/1" class="navbar-brand" style="width:250px;">
                <img th:src="@{/base/images/logo.png}" style="height:30px;">&nbsp;微电影
            </a>
        </div>
        <!--小屏幕导航按钮和logo-->
        <!--导航-->
        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a th:if="${session.user!=null}" class="curlink" href="/movie/recommend/1"><span class="glyphicon glyphicon-film"></span>推荐</a>
                </li>
                <li>
                    <a th:if="${session.user==null}" class="curlink" data-toggle="modal" data-target="#loginModal"><span class="glyphicon glyphicon-log-in"></span>登录</a>
                </li>
                <li>
                    <a th:if="${session.user==null}" class="curlink" data-toggle="modal" data-target="#registerModal"><span class="glyphicon glyphicon-plus"></span>注册</a>
                </li>
                <li>
                    <a th:if="${session.user!=null}" class="curlink" href="javascript:void(0)" onclick="loginOut()"><span class="glyphicon glyphicon-log-out"></span>退出</a>
                </li>
                <li>
                    <a th:if="${session.user!=null}" th:text="${session.user.name}"  class="curlink" href="/user/info"><span class="glyphicon glyphicon-user"></span></a>
                </li>
            </ul>
        </div>
        <!--导航-->

    </div>
</nav>
<!--导航-->
<!--内容-->
<div class="container" style="margin-top:76px">
    <div class="row">
        <div class="col-md-7">
            <div class="panel panel-info" style="border:1px solid white">
                <div class="panel-heading" style="background: white;border:1px solid white">
                    <h3><span class="glyphicon glyphicon-facetime-video"></span>&nbsp;电影介绍</h3>
                </div>
            </div>

        </div>
        <div class="col-md-7">
            <div class="col-md-5" style="height:350px;">
                <img th:src="@{${movie.img}}" height="350px">
            </div>
            <div class="col-md-7">
                <div class="panel panel-info">
                    <div class="panel-body" style="height:350px;">
                        <form id="movie-form">
                            <table class="table">
                                <input type="text" name="moveid" hidden="hidden" th:value="${movie.id}"></input>
                                <tr>
                                    <td style="width:40%;color:#ccc;font-weight:bold;font-style:italic;">
                                        <span class="glyphicon glyphicon-film" style="font-size: large;color: #0f74a8"></span>&nbsp;片名
                                    </td>
                                    <td th:text="${movie.name}"></td>
                                </tr>
                                <tr>
                                    <td style="color:#ccc;font-weight:bold;font-style:italic;">
                                        <span class="glyphicon glyphicon-tag " style="font-size: large;color: #0f74a8"></span>&nbsp;标签
                                    </td>
                                    <td th:text="${label.name}"></td>
                                </tr>
                                <tr>
                                    <td style="color:#ccc;font-weight:bold;font-style:italic;">
                                        <span class="glyphicon glyphicon-map-marker"style="font-size: large;color: #0f74a8"></span>&nbsp;地区
                                    </td>
                                    <td th:text="${movie.country}"></td>
                                </tr>
                                <tr>
                                    <td style="color:#ccc;font-weight:bold;font-style:italic;">
                                        <span class="glyphicon glyphicon-star"style="font-size: large;color: #0f74a8"></span>&nbsp;豆瓣评分
                                    </td>
                                    <td th:text="${movie.score}"></td>
                                </tr>

                                <tr>
                                    <td style="color:#ccc;font-weight:bold;font-style:italic;">
                                        <span class="glyphicon glyphicon-calendar"style="font-size: large;color: #0f74a8"></span>&nbsp;上映时间
                                    </td>
                                    <td th:text="${movie.time}"></td>
                                </tr>
                                <tr>
                                    <td style="color:#ccc;font-weight:bold;font-style:italic;">
                                        <span class="glyphicon glyphicon-download-alt"style="font-size: large;color: #0f74a8"></span>&nbsp;我要下载
                                    </td>
                                    <td>
                                        <a th:href="@{${movie.download}}">点击下载</a>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="color:#ccc;font-weight:bold;font-style:italic;">
                                        <span class="glyphicon glyphicon-pencil"style="font-size: large;color: #0f74a8"></span>&nbsp;打分
                                    </td>
                                    <td>
                                        <select name="score" class="selectpicker">
                                            <option value ="1">1</option>
                                            <option value ="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value ="5">5</option>
                                        </select>
                                        <button  type="button" onclick="s()" class="btn btn-xs" style="border-radius: 4px">提交评分</button>
                                    </td>
                                </tr>
                            </table>
                        </form>
                    </div>
                </div>

            </div>
        </div>
        <div class="col-md-3 col-md-offset-1" style=height:350px;">
        <tr>
            <td style="color:#ccc;font-weight:bold;font-style:italic;">
                <h3>猜你可能还喜欢</h3>
            </td>
            <a th:each="movie:${recommend}" href="">
                <h4 th:text="${movie.name}" style="color:#ccc;font-weight:bold;font-style:italic;">
                </h4>
            </a>
        </tr>
    </div>
    <div class="col-md-7" style="margin-top:10px;">
        <table class="table">
            <tr>
                <td  style="color:#ccc;font-weight:bold;font-style:italic;width: 15%;">
                    <span class="glyphicon glyphicon-picture" style="font-size: large;color: #0f74a8"></span>&nbsp;影片介绍
                </td>
                <td th:text="${movie.intro}">

                </td>
            </tr>
        </table>

    </div>
        <div class="col-md-12" style="margin-top:6px;">
            <div class="panel panel-danger">
                <div class="panel-heading">
                    <h3 class="panel-title"><span class="glyphicon glyphicon-comment"></span>&nbsp;电影评论</h3>
                </div>
                <div class="panel-body">
                    <div th:if="${session.user==null}" class="alert alert-danger alert-dismissible" role="alert">
                        <button type="button" class="close" data-dismiss="alert">
                            <span aria-hidden="true">×</span>
                            <span class="sr-only">Close</span>
                        </button>
                        <strong>请先<a href="javascript:void(0)" onclick="showLoginModel()" target="_blank" class="text-info">登录</a>，才可参与评论！</strong>
                    </div>
                    <form id="evaluation_form" style="margin-bottom:6px;">
                        <div class="form-group">
                            <div>
                                <label>内容</label>
                                <textarea id="evaluation" name="evaluation" class="col-md-12" style="height: 80px"></textarea>
                                <input type="text" id="movieId" name="movieid" th:attr="value=${movie.id}" hidden="hidden"></input>
                                <input type="text" id="userId" name="uid" th:attr="value=${id}" hidden="hidden"></input>
                            </div>
                            <div class="col-xs-12" id="error_content"></div>
                        </div>
                        <a onclick="subEvaluation()" class="btn btn-success" id="btn-sub"><span class="glyphicon glyphicon-edit"></span>&nbsp;提交评论</a>
                        &nbsp;
                        <a onclick="collection()" class="btn btn-danger" id="btn-col"><span class="glyphicon glyphicon-heart"></span>&nbsp;收藏电影</a>
                    </form>
                    <ul class="commentList">
                        <li class="item cl" th:each="evaluation:${list}">
                            <div class="comment-main">
                                <header class="comment-header">
                                    <div class="comment-meta">
                                        <a class="comment-author" href="javascript:void(0)" th:text="${evaluation.name}"></a>
                                        评论于
                                        <time title="2016-12-07 09:12:51" datetime="2016-12-07 09:12:51" th:text="${#dates.format(evaluation.date, 'yyyy-MM-dd')}"></time>
                                    </div>
                                </header>
                                <div class="comment-body">
                                    <p th:text="${evaluation.evaluation}"></p>
                                </div>
                            </div>
                        </li>
                    </ul>
                    <div class="col-md-12 text-center">
                        <nav aria-label="Page navigation">
                            <ul class="pagination">
                                <li>
                                    <a href="#" aria-label="First">
                                        <span aria-hidden="true">首页</span>
                                    </a>
                                </li>
                                <li>
                                    <a href="#" aria-label="Previous">
                                        <span aria-hidden="true">上一页</span>
                                    </a>
                                </li>
                                <li><a href="#">1&nbsp;/&nbsp;10</a></li>
                                <li>
                                    <a href="#" aria-label="Next">
                                        <span aria-hidden="true">下一页</span>
                                    </a>
                                </li>
                                <li>
                                    <a href="#" aria-label="Last">
                                        <span aria-hidden="true">尾页</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!--内容-->
<!--底部-->

<!--底部-->
<script th:src="@{/base/js/jquery.min.js}"></script>
<script th:src="@{/base/js/bootstrap.min.js}"></script>
<script th:src="@{/base/js/jquery.singlePageNav.min.js}"></script>
<script th:src="@{/base/js/jquery.serializejson.min.js}"></script>
<script th:src="@{/base/js/jquery.gritter.min.js}"></script>
<script th:src="@{/base/js/wow.min.js}"></script>
<script th:src="@{//cdn.bootcss.com/holder/2.9.4/holder.min.js}"></script>
<script th:src="@{/base/js/jquery.validate.min.js}"></script>
<script>
</script>

<script type="text/javascript" language='javascript' th:inline="javascript">
    function collection() {
        if ([[${session.user}]]==null){
            showLoginModel();
            return false;
        }
        var data = JSON.stringify($("#movie-form").serializeJSON());
        var id = [[${id}]];
        $.ajax({
            url:"/collection/"+id,
            type: "post",
            contentType: false,
            processData: false,
            data:data,
            contentType: 'application/json',
            dataType: "json",
            success:function (result) {
                if (result.state) {
                    successTip(" 收藏电影成功！");
                }else {
                    errorTip(result.info);
                }
            },
            error:function () {
                errorTip("收藏电影失败！");
            }
        });
    }
    function subEvaluation() {
        if ([[${session.user}]]==null){
            showLoginModel();
            return false;
        }
        var evaluation = document.getElementById("evaluation").value;
        if(evaluation == ""||evaluation==null){
            alert("请输入评论");
            return ;
        }
        var jsonString = JSON.stringify($("#evaluation_form").serializeJSON());
        var request = new XMLHttpRequest();
        request.open("post","/evaluation/add");
        request.setRequestHeader("Content-type","application/json");
        request.send(jsonString);
        request.onreadystatechange = function () {
            if(request.readyState==4)
            {
                if(request.status==200)//判断是否成功,如果是200，就代表成功
                {
                    successTip("评论成功！");
                }
                else
                {
                   errorTip("评论失败!");
                }
            }
        }
    }
</script>

<script language='javascript' th:inline="javascript">
    function s() {
        if ([[${session.user}]]==null){
            showLoginModel();
        }
        if ([[${session.user}]]!=null) {
            var data = JSON.stringify($("#movie-form").serializeJSON());
            var id = [[${id}]];
            $.ajax({
                url:"/score/"+id,
                type: "post",
                contentType: false,
                processData: false,
                data:data,
                contentType: 'application/json',
                dataType: "json",
                success:function (result) {
                    if (result.state) {
                        successTip(" 保存评分成功！");
                    }else {
                        errorTip(result.info);
                    }
                },
                error:function () {
                    errorTip("保存评分失败！");
                }
            });
        }
    }
</script>

<script type="text/javascript">

    jQuery.validator.addMethod("isMobile", function(value, element) {
        var length = value.length;
        var mobile = /^(13[0-9]{9})|(18[0-9]{9})|(14[0-9]{9})|(17[0-9]{9})|(15[0-9]{9})$/;
        return this.optional(element) || (length == 11 && mobile.test(value));
    }, "请正确填写您的手机号码");

    var movieName="";
    $(document).ready(function(){
        $("#searchName").on("input",function(e){
            movieName=e.delegateTarget.value;
        });
        validateLoginForm();
        validateRegisterForm()
    });


    function validateRegisterForm(){
        return $("#register_form").validate({
            errorElement: 'div',
            errorClass: 'help-block',
            focusInvalid: false,
            debug: true,
            rules: {
                name:{
                    required:true,
                },
                mail:{
                    required:true,
                    email:true,
                    remote:{
                        url:"/user/isExit",
                        type:"Post",
                        dataType: "json"
                    }
                },
                phonenumber:{
                    required:true,
                    isMobile:true

                },
                passworld:{
                    required:true
                },
                repassword:{
                    required:true,
                    equalTo: "#passworld"
                }
            },
            messages:{
                name:{
                    required:"请输入昵称",
                },
                mail:{
                    required:"请输入邮箱",
                    email:"请输入正确的邮箱格式",
                    remote:"该邮箱已经注册"
                },
                phonenumber:{
                    required:"请输入电话号码",
                },
                passworld:{
                    required:"请输入密码"
                },
                repassword:{
                    required:"请再次输入密码",
                    equalTo: "两次输入密码不相同"
                }
            },
            highlight: function (e) {
                $(e).closest('.form-group').removeClass('has-info').addClass('has-error');
            }
        });
    }

    function validateLoginForm(){
        return $("#login_form").validate({
            errorElement: 'div',
            errorClass: 'help-block',
            focusInvalid: false,
            rules: {
                toEmail:{
                    required:true,
                    email:true
                },
                passworld:{
                    required:true
                }
            },
            messages:{
                mail:{
                    required:"请输入邮箱",
                    email:"请输入正确的邮箱格式",
                },
                passworld:{
                    required:"请输入密码"
                }
            },
            highlight: function (e) {
                $(e).closest('.form-group').removeClass('has-info').addClass('has-error');
            }
        });
    }

    function login() {
        if (validateLoginForm().form()){
            var data = JSON.stringify($("#login_form").serializeJSON());
            $.ajax({
                url:"/user/login",
                type: "post",
                contentType: false,
                processData: false,
                data:data,
                contentType: 'application/json',
                dataType: "json",
                success:function (result) {
                    if (result.state) {
                        successTip("登录成功！");
                        setTimeout(function () {
                            top.location.href = '/movie/recommend/1'
                        },1000)
                    }else {
                        errorTip(result.info);
                    }
                },
                error:function () {
                    errorTip("登录失败！");
                }
            });
        }
    }

    function register() {
        if(validateRegisterForm().form()){
            var data = JSON.stringify($("#register_form").serializeJSON());
            $.ajax({
                url:"/user/register",
                type: "post",
                contentType: false,
                processData: false,
                data:data,
                contentType: 'application/json',
                dataType: "json",
                success:function (result) {
                    if (result.state) {
                        successTip("注册成功！");
                        setTimeout(function () {
                            top.location.href = '/movie/recommend/1'
                        },1000)
                    }else {
                        errorTip(result.info);
                    }
                },
                error:function () {
                    errorTip("注册失败！");
                }
            });
        }
    }

    function successTip(msg){
        $.gritter.add({
            title: '提示信息',
            text: msg,
            class_name: 'gritter-success gritter-light'
        });
    }

    function errorTip(msg){
        $.gritter.add({
            title: '提示信息',
            text: msg,
            class_name: 'gritter-error gritter-light'
        });
    }

    function loginOut() {
        $.ajax({
            url:"/user/exit",
            type:"get",
            success:function (result) {
                if (result.state){
                    successTip("注销登录成功！");
                    setTimeout(function () {
                        top.location.href = '/movie/list/2018/1'
                    },500)
                } else {
                    errorTip(result.info);
                }
            },
            error:function (result) {
                errorTip("注销失败！")
            }
        })
    }
    
    function showLoginModel() {
        $("#loginModal").modal("show");
    }
</script>
</body>
</html>
